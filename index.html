<head>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  <style>
    body {
      margin: 0;
    }
  </style>

  <script src="https://unpkg.com/d3-array"></script>
  <script src="https://unpkg.com/d3-scale"></script>

  <script src="https://unpkg.com/globe.gl"></script>
  <!-- <script src="../../dist/globe.gl.js"></script> -->
</head>

<body>
  
  <div style="position:absolute; z-index:20; width:400px; height: 100vh; border-radius: 10px; background-color: rgba(0, 0, 0, 0.7); ">
    <h1 style="font-size: 30px; font-weight: bold; color: white; text-align: center; margin: 8px 0 8px 0;">Moonquake Map</h1>
    <div class="" style="text-align: center;">
      <input id="yearslide" min="0" max="11" type="range" class="form-range" id="customRange1" style="width: 80%;">
      <div style="margin-top: 5px;">
        <label id="yearlabel" for="customRange1" class="form-label" style="display: inline-block; width:60px; text-align:center; font-size: 25px; border-radius: 5px; padding: 0px 8px 0 8px;; background-color: rgba(255, 255, 255, 0.6);"></label>
      </div>
    </div>
  </div>
  
  <div id="cont" style="display: none;position:absolute; right: 0px; z-index:20; width:400px; height: 400px; background-color: rgba(200, 255, 255, 0.6)">
    <div style="position: absolute; right:5px; cursor: pointer;" onclick="document.getElementById('cont').style.display = 'none';">
      <svg width="24px" height="24px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.72 5.72a.75.75 0 011.06 0L12 10.94l5.22-5.22a.75.75 0 111.06 1.06L13.06 12l5.22 5.22a.75.75 0 11-1.06 1.06L12 13.06l-5.22 5.22a.75.75 0 01-1.06-1.06L10.94 12 5.72 6.78a.75.75 0 010-1.06z"/></svg>
    </div>
    <img id="plots" src="" alt="">
  </div>



  <script>
     let months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    document.getElementById('yearslide').addEventListener('input', (event) => {
      document.getElementById('yearlabel').innerText = months[event.target.value];

    });
  </script>

  <div id="globeViz"></div>
  
  

  <script>
    const colorScale = d3.scaleOrdinal(['orangered', 'mediumblue', 'darkgreen', 'yellow']);

    const labelsTopOrientation = new Set(['Apollo 12', 'Luna 2', 'Luna 20', 'Luna 21', 'Luna 24', 'LCROSS Probe']); // avoid label collisions


    const elem = document.getElementById('globeViz');

    /*
    const gData = [[...Array(N).keys()]].map(() => ({
      lat: (Math.random() - 0.5) * 180,
      lng: (Math.random() - 0.5) * 360,
      maxR: 10,
      propagationSpeed: 10,
      repeatPeriod: 1000
    }));
    */

    const N = 10;
    
     let marker = `<svg viewBox="-4 0 36 36">
        <path fill="currentColor" d="M14,0 C21.732,0 28,5.641 28,12.6 C28,23.963 14,36 14,36 C14,36 0,24.064 0,12.6 C0,5.641 6.268,0 14,0 Z"></path>
        <circle fill="black" cx="14" cy="14" r="7"></circle>
        </svg>`;

    let markdata = [{
      lat: (Math.random() - 0.5) * 180,
      lng: (Math.random() - 0.5) * 360,
      size: 7 + Math.random() * 30,
      color: ['red', 'white', 'blue', 'green'][Math.round(Math.random() * 3)]
    }];
    

    
    
    async function start() {
      
      let data = await fetch('./moonquakes.json');
      let cleandata = await data.json();

      const gData = [...Array(cleandata.length).keys()].map((elem, index) => ({
        lat: cleandata[index].lat,
        lng: cleandata[index].lng,
        maxR: cleandata[index].magnitude* 5,
        propagationSpeed: 5,
        repeatPeriod: 500
      }));

      console.log(gData);



      const moon = Globe()
        .globeImageUrl('./lunar_surface.jpg')
        .bumpImageUrl('./lunar_bumpmap.jpg')
        .backgroundImageUrl('https://unpkg.com/three-globe@2.24.7/example/img/night-sky.png')
        .showGraticules(false)
        .showAtmosphere(false) // moon has no atmosphere
        // .labelText('label')
        // .labelSize(1.7)
        // .labelDotRadius(0.4)
        // .labelDotOrientation(d => labelsTopOrientation.has(d.label) ? 'top' : 'bottom')
  //       .labelColor(d => colorScale(d.agency))
  //       .labelLabel(d => `
  //           <div style="background-color: lightgray;"
  // ><b>${d.label}</b></div>
  //           <div>${d.agency} - ${d.program} Program</div>
  //           <div>Landing on <i>${new Date(d.date).toLocaleDateString()}</i></div>
  //         `)
  //       .onLabelClick(d => window.open(d.url, '_blank'))
        .ringsData(gData)
        .ringColor(() => colorInterpolator)
        .ringMaxRadius('maxR')
        .ringPropagationSpeed('propagationSpeed')
        .ringRepeatPeriod('repeatPeriod')
        .htmlElementsData(markdata)
        .htmlElement(d => {
          const el = document.createElement('div');
          el.innerHTML = marker;
          el.style.color = d.color;
          el.style.width = `${d.size}px`;
          el.style['pointer-events'] = 'auto';
          el.style.cursor = 'pointer';
          el.onclick = () => {

            document.getElementById('plots').src = './chart.jpg';
            document.getElementById('cont').style.display = "block";
          };
          return el;
        })
        (document.getElementById('globeViz'));



      const colorInterpolator = t => `rgba(255,100,50,${Math.sqrt(1 - t)})`;

      fetch('./moonquakes.json').then(r => r.json()).then(landingSites => {
        moon.labelsData(landingSites);
      });




    }

    start();

    
  </script>
</body>
